<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M3U8 åœ¨çº¿æ’­æ”¾å™¨</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root { --bg:#0b0c0e; --fg:#e7e7ea; --muted:#9aa0a6; --accent:#4f46e5; }
    html { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    body { margin: 0; background: var(--bg); color: var(--fg); }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 24px; margin: 0 0 12px; }
    p { color: var(--muted); }
    .card { background: #111318; border: 1px solid #1f2430; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,.35); padding: 16px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input[type="url"] { flex: 1 1 560px; padding: 12px 14px; border-radius: 12px; border: 1px solid #2a3242; background: #0e1117; color: var(--fg); outline: none; }
    input[type="url"]::placeholder { color: #6b7280; }
    button { padding: 12px 16px; border-radius: 12px; border: 1px solid #2a3242; background: #151a24; color: var(--fg); cursor: pointer; font-weight: 600; }
    button.primary { background: var(--accent); border-color: #3e36c5; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    label { display: inline-flex; align-items: center; gap: 6px; color: #cbd5e1; }
    video { width: 100%; max-height: 65vh; background: #000; border-radius: 16px; margin-top: 12px; }
    .pill { display:inline-flex; gap:8px; align-items:center; background:#0f1420; border:1px solid #1f2430; padding:8px 12px; border-radius:999px; font-size:12px; color:#cbd5e1; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 8px; margin-top: 10px; }
    .stat { background:#0f1420; border:1px solid #1f2430; border-radius:12px; padding:10px 12px; }
    .stat h4 { margin:0 0 4px; font-size:12px; color:#94a3b8; font-weight:600; }
    .stat .v { font-variant-numeric: tabular-nums; font-size:14px; }
    .foot { margin-top:10px; font-size:12px; color:#94a3b8; }
    a { color:#a5b4fc; text-decoration: none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ¬ M3U8 åœ¨çº¿æ’­æ”¾å™¨</h1>
    <div class="card">
      <div class="row" style="margin-bottom:10px">
        <input id="url" type="url" value="http://192.168.100.1:4022/rtp/239.3.1.129:8008" />
        <button id="load" class="primary">åŠ è½½</button>
        <button id="play">æ’­æ”¾/æš‚åœ</button>
        <label><input id="autoplay" type="checkbox" checked> è‡ªåŠ¨æ’­æ”¾</label>
        <label><input id="muted" type="checkbox"> é™éŸ³</label>
      </div>
      <div class="row" style="margin-bottom:10px">
        <span class="pill">çŠ¶æ€ï¼š<span id="status">ç©ºé—²</span></span>
        <span class="pill">æ¸…æ™°åº¦ï¼š<span id="level">-</span></span>
        <span class="pill">ç¼“å†²ï¼š<span id="buffer">-</span>s</span>
      </div>
      <video id="player" controls playsinline></video>
      <div class="grid">
        <div class="stat"><h4>åˆ†è¾¨ç‡</h4><div class="v" id="res">-</div></div>
        <div class="stat"><h4>å¸§ç‡</h4><div class="v" id="fps">-</div></div>
        <div class="stat"><h4>ç ç‡</h4><div class="v" id="br">-</div></div>
        <div class="stat"><h4>å»¶è¿Ÿ(çº¦)</h4><div class="v" id="latency">-</div></div>
      </div>
      <div class="foot">
        Â· è¯´æ˜ï¼šChrome/Edge/Firefox é€šè¿‡ <code>hls.js</code> æ’­æ”¾ï¼›Safari/iOS åŸç”Ÿæ”¯æŒ HLSã€‚è‹¥è·¨åŸŸæˆ– Referer å—é™ï¼Œè¯·åœ¨æœåŠ¡ç«¯å…è®¸ CORS/æ­£ç¡®é˜²ç›—é“¾ã€‚<br/>
        Â· å¼€æºåº“ï¼š<a href="https://github.com/video-dev/hls.js" target="_blank" rel="noreferrer">hls.js</a>
      </div>
    </div>
  </div>

  <!-- hls.js from jsDelivr -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const urlInput = document.getElementById('url');
    const loadBtn = document.getElementById('load');
    const playBtn = document.getElementById('play');
    const video = document.getElementById('player');
    const statusEl = document.getElementById('status');
    const levelEl = document.getElementById('level');
    const bufferEl = document.getElementById('buffer');
    const resEl = document.getElementById('res');
    const fpsEl = document.getElementById('fps');
    const brEl = document.getElementById('br');
    const latEl = document.getElementById('latency');
    const autoplay = document.getElementById('autoplay');
    const muted = document.getElementById('muted');

    // è®°ä½ä¸Šæ¬¡åœ°å€
    urlInput.value = localStorage.getItem('m3u8_url') || '';

    muted.addEventListener('change', () => video.muted = muted.checked);
    video.muted = muted.checked;

    function setStatus(text) { statusEl.textContent = text; }

    let hls; let lastPTS = null; let liveSync = 0;

    async function attach(url) {
      if (!url) { alert('è¯·è¾“å…¥ m3u8 åœ°å€'); return; }
      localStorage.setItem('m3u8_url', url);
      setStatus('åŠ è½½ä¸­â€¦');

      // å…ˆæ¸…ç†æ—§å®ä¾‹
      if (hls) { hls.destroy(); hls = null; }
      video.removeAttribute('src');
      video.load();

      // Safari / iOS åŸç”Ÿ
      if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        bindVideoEvents();
        if (autoplay.checked) video.play().catch(()=>{});
        setStatus('åŸç”Ÿæ’­æ”¾');
        return;
      }

      if (window.Hls && window.Hls.isSupported()) {
        hls = new Hls({
          // å¯¹ç›´æ’­æ›´å‹å¥½çš„ä¸€äº›è®¾ç½®
          liveDurationInfinity: true,
          maxLiveSyncPlaybackRate: 1.5,
          enableWorker: true,
          backBufferLength: 90,
        });
        hls.on(Hls.Events.MEDIA_ATTACHED, () => setStatus('åª’ä½“å·²è¿æ¥'));
        hls.on(Hls.Events.MANIFEST_PARSED, (_, data) => {
          setStatus(`æ¸…å•å°±ç»ªï¼š${data.levels.length} ä¸ªæ¸…æ™°åº¦`);
          updateLevelInfo();
          if (autoplay.checked) video.play().catch(()=>{});
        });
        hls.on(Hls.Events.LEVEL_SWITCHED, updateLevelInfo);
        hls.on(Hls.Events.ERROR, (_, data) => {
          console.warn('HLS error', data);
          const { type, details, fatal } = data;
          if (fatal) {
            switch (type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                setStatus('ç½‘ç»œé”™è¯¯ï¼Œé‡è¯•â€¦');
                hls.startLoad();
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                setStatus('åª’ä½“é”™è¯¯ï¼Œå°è¯•æ¢å¤â€¦');
                hls.recoverMediaError();
                break;
              default:
                setStatus('è‡´å‘½é”™è¯¯ï¼Œé‡æ–°åŠ è½½â€¦');
                hls.destroy();
                attach(url);
                break;
            }
          } else {
            // éè‡´å‘½é”™è¯¯å¯å¿½ç•¥æˆ–è®°å½•
          }
        });
        hls.attachMedia(video);
        hls.loadSource(url);
        bindVideoEvents();
      } else {
        setStatus('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ HLS');
        alert('è¯¥æµè§ˆå™¨ä¸æ”¯æŒ HLS.jsï¼Œè¯·æ›´æ¢ Chrome/Edge/Firefox/Safariã€‚');
      }
    }

    function updateLevelInfo() {
      if (hls && hls.levels && hls.currentLevel !== undefined) {
        const i = hls.currentLevel;
        const L = hls.levels[i] || {};
        levelEl.textContent = i >= 0 ? `#${i}` : '-';
        resEl.textContent = L.width ? `${L.width}Ã—${L.height}` : '-';
        fpsEl.textContent = L.frameRate ? `${Math.round(L.frameRate)} fps` : '-';
        brEl.textContent = L.bitrate ? `${Math.round(L.bitrate/1000)} kbps` : '-';
      } else {
        levelEl.textContent = '-';
        resEl.textContent = '-';
        fpsEl.textContent = '-';
        brEl.textContent = '-';
      }
    }

    function bindVideoEvents() {
      video.addEventListener('loadedmetadata', () => setStatus('å…ƒæ•°æ®å·²åŠ è½½'));
      video.addEventListener('playing', () => setStatus('æ’­æ”¾ä¸­'));
      video.addEventListener('pause', () => setStatus('å·²æš‚åœ'));
      video.addEventListener('error', () => setStatus('æ’­æ”¾é”™è¯¯'));
    }

    // ç®€æ˜“ç»Ÿè®¡ï¼šç¼“å†²ã€å»¶è¿Ÿä¼°ç®—
    setInterval(() => {
      try {
        const buf = video.buffered;
        const ct = video.currentTime;
        let end = ct;
        for (let i=0;i<buf.length;i++) end = Math.max(end, buf.end(i));
        const buffered = Math.max(0, end - ct);
        bufferEl.textContent = buffered.toFixed(1);

        // ç›´æ’­å»¶è¿Ÿä¼°ç®—ï¼šåŸºäº PTS æ¨æ–­ï¼ˆä»…è¿‘ä¼¼ï¼‰
        if (hls && hls.levelDetails && hls.levelDetails.live) {
          // hls.latency + liveSyncPosition may be available in some builds
          if (hls.latency) {
            liveSync = hls.latency;
          } else if (hls.levelDetails && hls.levelDetails.edge) {
            liveSync = Math.max(0, hls.levelDetails.edge - video.currentTime);
          }
          latEl.textContent = (liveSync || 0).toFixed(1) + 's';
        } else {
          latEl.textContent = '-';
        }
      } catch (_) {}
    }, 500);

    loadBtn.addEventListener('click', () => attach(urlInput.value.trim()));
    playBtn.addEventListener('click', () => {
      if (video.paused) video.play().catch(()=>{}); else video.pause();
    });

    // å›è½¦ç›´æ¥åŠ è½½
    urlInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') attach(urlInput.value.trim());
    });

    // å¦‚æœåœ°å€æ å·²æœ‰ ?src=xxx è‡ªåŠ¨åŠ è½½
    const params = new URLSearchParams(location.search);
    const preset = params.get('src');
    if (preset) {
      urlInput.value = preset;
      attach(preset);
    }
  </script>
</body>
</html>
